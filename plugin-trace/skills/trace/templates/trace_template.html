<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Dashboard - Single-Run Execution Monitor</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --accent-cyan: #06b6d4;
            --border-color: #475569;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header h1 .icon { font-size: 1.75rem; }

        .header-meta {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .header-meta span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-section { margin-bottom: 2rem; }

        .sidebar-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .drop-zone .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

        .drop-zone p { font-size: 0.875rem; color: var(--text-secondary); }

        .drop-zone small { font-size: 0.75rem; color: var(--text-muted); }

        /* Validation Panel */
        .validation-panel {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-color);
        }

        .validation-item:last-child { border-bottom: none; }

        .validation-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .validation-icon.pass { background: var(--success); color: white; }
        .validation-icon.fail { background: var(--error); color: white; }
        .validation-icon.pending { background: var(--text-muted); color: white; }

        /* Main Content */
        .content { padding: 1.5rem 2rem; overflow-y: auto; }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state .icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }

        .empty-state h2 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .dashboard-grid.active { display: grid; }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .card.full-width { grid-column: 1 / -1; }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body { padding: 1.25rem; }

        /* Run Info */
        .run-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .run-info-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .run-info-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .run-info-item .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        /* Group Relation */
        .group-relation {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .group-relation-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .relation-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .relation-badge.sequential {
            background: rgba(234, 179, 8, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }

        .relation-badge.parallel {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .relation-badge.dependency {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent-purple);
            border: 1px solid var(--accent-purple);
        }

        .relation-badge.unknown {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        /* Swimlane Timeline */
        .swimlane-container { overflow-x: auto; padding-bottom: 1rem; }
        .swimlane { min-width: 600px; }

        .swimlane-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .swimlane-label {
            width: 120px;
            flex-shrink: 0;
            font-size: 0.85rem;
            font-weight: 500;
            padding-right: 1rem;
            text-align: right;
            color: var(--text-secondary);
        }

        .swimlane-track {
            flex: 1;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .swimlane-bar {
            position: absolute;
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .swimlane-bar.parallel {
            background: linear-gradient(90deg, var(--accent-green) 0%, #16a34a 100%);
        }
        .swimlane-bar.sequential {
            background: linear-gradient(90deg, var(--accent-yellow) 0%, #ca8a04 100%);
        }
        .swimlane-bar.dependency {
            background: linear-gradient(90deg, var(--accent-purple) 0%, #7c3aed 100%);
        }

        .swimlane-bar.completed { opacity: 1; }
        .swimlane-bar.in-progress { animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Group Flow Diagram */
        .group-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1.5rem;
            flex-wrap: wrap;
        }

        .group-box {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            min-width: 180px;
            text-align: center;
        }

        .group-box.parallel { border-color: var(--accent-green); }
        .group-box.sequential { border-color: var(--accent-yellow); }
        .group-box.dependency { border-color: var(--accent-purple); }

        .group-box .group-title { font-weight: 600; margin-bottom: 0.5rem; }

        .group-box .group-type {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .group-box.parallel .group-type {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .group-box.sequential .group-type {
            background: rgba(234, 179, 8, 0.2);
            color: var(--accent-yellow);
        }

        .group-box.dependency .group-type {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent-purple);
        }

        .group-box .group-tasks { font-size: 0.8rem; color: var(--text-secondary); }
        .flow-arrow { font-size: 2rem; color: var(--accent-blue); }

        /* Skills Table */
        .skills-table { width: 100%; border-collapse: collapse; }

        .skills-table th,
        .skills-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .skills-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .skills-table tr:hover td { background: var(--bg-tertiary); }

        .skill-name { font-weight: 600; color: var(--accent-purple); }

        .skill-agent {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .skill-scope {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-secondary);
        }

        /* Artifacts List */
        .artifacts-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .artifact-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .artifact-icon {
            width: 32px;
            height: 32px;
            background: var(--accent-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .artifact-name { flex: 1; font-weight: 500; }

        .artifact-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        /* Validation Summary */
        .validation-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .validation-stat {
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .validation-stat .number { font-size: 2rem; font-weight: 700; }

        .validation-stat .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .validation-stat.pass .number { color: var(--success); }
        .validation-stat.fail .number { color: var(--error); }
        .validation-stat.warn .number { color: var(--warning); }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-badge.success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .status-badge.failure { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .status-badge.pending { background: rgba(100, 116, 139, 0.2); color: var(--text-muted); }
        .status-badge.unknown { background: rgba(100, 116, 139, 0.2); color: var(--text-secondary); }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .run-info-grid { grid-template-columns: repeat(2, 1fr); }
            .validation-summary { grid-template-columns: 1fr; }
        }

        /* Hidden file input */
        #fileInput { display: none; }

        /* Detailed validation list */
        .validation-details { margin-top: 1rem; }

        .validation-detail-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .validation-detail-item .icon { flex-shrink: 0; font-size: 1rem; }
        .validation-detail-item .content { flex: 1; }
        .validation-detail-item .title { font-weight: 500; margin-bottom: 0.25rem; }
        .validation-detail-item .desc { font-size: 0.8rem; color: var(--text-secondary); }

        /* Tab navigation for mobile sidebar toggle */
        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            background: var(--accent-blue);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        @media (max-width: 1024px) {
            .mobile-toggle { display: flex; align-items: center; justify-content: center; }
        }
    </style>
</head>
<body>
<header class="header">
    <h1>
        <span class="icon">ğŸ“Š</span>
        Trace Dashboard
    </h1>
    <div class="header-meta">
        <span id="runIdDisplay">
            <span>ğŸ”–</span> Run ID: <strong>-</strong>
        </span>
        <span id="statusDisplay">
            <span>âš¡</span> ìƒíƒœ: <span class="status-badge pending">ëŒ€ê¸° ì¤‘</span>
        </span>
    </div>
</header>

<div class="main-container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <h3>ğŸ“ Trace íŒŒì¼ ë¡œë“œ</h3>
            <div class="drop-zone" id="dropZone">
                <div class="icon">ğŸ“„</div>
                <p>Trace JSON íŒŒì¼ì„<br>ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                <small>*_trace.json</small>
            </div>
            <input type="file" id="fileInput" accept=".json">
        </div>

        <div class="sidebar-section">
            <h3>âœ… ê·œì•½ ê²€ì¦ í˜„í™©</h3>
            <div class="validation-panel" id="validationPanel">
                <div class="validation-item">
                    <div class="validation-icon pending">?</div>
                    <span>Trace íŒŒì¼ ë‹¨ì¼ì„±</span>
                </div>
                <div class="validation-item">
                    <div class="validation-icon pending">?</div>
                    <span>&lt;T&gt; ì‹œê°„ ì¼ê´€ì„±</span>
                </div>
                <div class="validation-item">
                    <div class="validation-icon pending">?</div>
                    <span>ê·¸ë£¹ ê°„ ê´€ê³„ ëª…ì‹œ</span>
                </div>
                <div class="validation-item">
                    <div class="validation-icon pending">?</div>
                    <span>ìŠ¤í‚¬ ì‚¬ìš© ê¸°ë¡</span>
                </div>
                <div class="validation-item">
                    <div class="validation-icon pending">?</div>
                    <span>í•„ìˆ˜ ì„¹ì…˜ ì™„ë¹„</span>
                </div>
            </div>
        </div>
    </aside>

    <main class="content">
        <div class="empty-state" id="emptyState">
            <div class="icon">ğŸ“‹</div>
            <h2>Trace íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”</h2>
            <p>ì™¼ìª½ ì˜ì—­ì— *_trace.json íŒŒì¼ì„ ë“œë˜ê·¸ì•¤ë“œë¡­í•˜ì„¸ìš”</p>
        </div>

        <div class="dashboard-grid" id="dashboardGrid">
            <!-- Run Info Card -->
            <div class="card full-width">
                <div class="card-header">
                    <h3><span>ğŸ¯</span> ì‹¤í–‰ ì •ë³´ (Run Info)</h3>
                    <span class="status-badge success" id="runStatus">ì™„ë£Œ</span>
                </div>
                <div class="card-body">
                    <div class="run-info-grid" id="runInfoGrid">
                        <div class="run-info-item">
                            <div class="label">Run ID</div>
                            <div class="value" id="infoRunId">-</div>
                        </div>
                        <div class="run-info-item">
                            <div class="label">ìš”ì²­ ì‹œê°</div>
                            <div class="value" id="infoStartTime">-</div>
                        </div>
                        <div class="run-info-item">
                            <div class="label">ê·¸ë£¹ ìˆ˜</div>
                            <div class="value" id="infoGroupCount">-</div>
                        </div>
                        <div class="run-info-item">
                            <div class="label">ìŠ¤í‚¬ ì‚¬ìš©</div>
                            <div class="value" id="infoSkillCount">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group Relation Card -->
            <div class="card full-width">
                <div class="card-header">
                    <h3><span>ğŸ”—</span> ê·¸ë£¹ ê°„ ì‹¤í–‰ ê´€ê³„</h3>
                </div>
                <div class="card-body">
                    <div class="group-relation" id="groupRelation">
                        <div class="group-relation-header">
                            <span>ğŸ“Œ</span> ê·¸ë£¹ ê°„ ê´€ê³„:
                        </div>
                        <div id="relationBadge"></div>
                    </div>
                    <div class="group-flow" id="groupFlow"></div>
                </div>
            </div>

            <!-- Swimlane Timeline Card -->
            <div class="card full-width">
                <div class="card-header">
                    <h3><span>ğŸ“Š</span> ìŠ¤ìœ”ë ˆì¸ íƒ€ì„ë¼ì¸</h3>
                </div>
                <div class="card-body">
                    <div class="swimlane-container">
                        <div class="swimlane" id="swimlane"></div>
                    </div>
                </div>
            </div>

            <!-- Skills Usage Card -->
            <div class="card full-width">
                <div class="card-header">
                    <h3><span>ğŸ› ï¸</span> ìŠ¤í‚¬ ì‚¬ìš© ê¸°ë¡</h3>
                    <span id="skillCount" style="font-size: 0.85rem; color: var(--text-secondary);">0ê°œ</span>
                </div>
                <div class="card-body" style="padding: 0;">
                    <table class="skills-table" id="skillsTable">
                        <thead>
                        <tr>
                            <th>ìŠ¤í‚¬ëª…</th>
                            <th>ì‚¬ìš© ì£¼ì²´</th>
                            <th>Scope (ì½ì€ ë²”ìœ„)</th>
                            <th>ê²°ê³¼ ìš”ì•½</th>
                            <th>ì¶œë ¥ë¬¼</th>
                        </tr>
                        </thead>
                        <tbody id="skillsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Artifacts Card -->
            <div class="card">
                <div class="card-header">
                    <h3><span>ğŸ“¦</span> ìƒì„±ëœ ì‚°ì¶œë¬¼</h3>
                </div>
                <div class="card-body">
                    <div class="artifacts-list" id="artifactsList"></div>
                </div>
            </div>

            <!-- Validation Summary Card -->
            <div class="card">
                <div class="card-header">
                    <h3><span>âœ…</span> ê²€ì¦ ê²°ê³¼ ìš”ì•½</h3>
                </div>
                <div class="card-body">
                    <div class="validation-summary" id="validationSummary">
                        <div class="validation-stat pass">
                            <div class="number" id="passCount">0</div>
                            <div class="label">í†µê³¼</div>
                        </div>
                        <div class="validation-stat fail">
                            <div class="number" id="failCount">0</div>
                            <div class="label">ì‹¤íŒ¨</div>
                        </div>
                        <div class="validation-stat warn">
                            <div class="number" id="warnCount">0</div>
                            <div class="label">ê²½ê³ </div>
                        </div>
                    </div>
                    <div class="validation-details" id="validationDetails"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<button class="mobile-toggle" id="mobileToggle">ğŸ“</button>

<script>
    // State management
    let traceData = null;
    let validationResults = [];

    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const emptyState = document.getElementById('emptyState');
    const dashboardGrid = document.getElementById('dashboardGrid');
    const validationPanel = document.getElementById('validationPanel');

    // File drop handlers
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    // Handle file loading (JSON only)
    function handleFile(file) {
        if (!file.name.endsWith('.json')) {
            alert('JSON íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            parseTraceJSON(e.target.result, file.name);
        };
        reader.readAsText(file);
    }

    // Parse Trace JSON (single-run contract)
    function parseTraceJSON(jsonText, fileName) {
        try {
            const data = JSON.parse(jsonText);

            // Normalize / fallback (ë””í´íŠ¸ ì˜ë¯¸ë¥¼ ë§Œë“¤ì§€ ì•Šê¸° ìœ„í•´ ìµœì†Œí•œë§Œ ë³´ì •)
            traceData = {
                fileName: data.fileName || fileName,
                runId: data.runId || extractRunIdFromFilename(fileName) || 'ì•Œ ìˆ˜ ì—†ìŒ',
                requestSummary: data.summary || data.requestSummary || 'ìš”ì²­ ìš”ì•½ ì—†ìŒ',
                groupRelation: normalizeGroupRelation(data.groupRelation),
                groups: Array.isArray(data.groups) ? data.groups : [],
                skills: Array.isArray(data.skills) ? data.skills : [],
                artifacts: Array.isArray(data.artifacts) ? data.artifacts : [],
                status: normalizeStatus(data.status)
            };

            validationResults = runValidations(traceData, jsonText);
            updateDashboard();
        } catch (err) {
            console.error(err);
            alert('Trace JSON íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. JSON í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
        }
    }

    function extractRunIdFromFilename(fileName) {
        const m = fileName.match(/^(\d{12})_/);
        return m ? m[1] : null;
    }

    function normalizeStatus(status) {
        if (status === 'success' || status === 'failure' || status === 'pending' || status === 'unknown') return status;
        // legacy values
        if (typeof status === 'string') {
            if (status.includes('ì„±ê³µ') || status.includes('ì™„ë£Œ')) return 'success';
            if (status.includes('ì‹¤íŒ¨') || status.includes('ì˜¤ë¥˜')) return 'failure';
        }
        return 'unknown';
    }

    function normalizeGroupRelation(gr) {
        // groupRelationì€ â€œë””í´íŠ¸â€ë¥¼ ë§Œë“¤ë©´ ì•ˆ ë˜ë¯€ë¡œ, textê°€ ì—†ìœ¼ë©´ unknown ê³ ì •
        const fallback = { found: false, text: 'ëª…ì‹œë˜ì§€ ì•ŠìŒ', type: 'unknown' };
        if (!gr || typeof gr !== 'object') return fallback;

        const text = (gr.text || '').trim();
        const type = (gr.type || '').trim();

        if (!text) return fallback;

        const normType =
            (type === 'sequential' || type === 'parallel' || type === 'dependency') ? type :
            (text.includes('ë³‘ë ¬') ? 'parallel' : text.includes('ì˜ì¡´') ? 'dependency' : 'sequential');

        return { found: true, text, type: normType };
    }

    // Validation functions (JSON contract)
    function runValidations(data, rawText) {
        const results = [];

        // 1. Trace ë‹¨ì¼ì„± (íŒŒì¼ëª… í˜•ì‹)
        results.push({
            id: 'trace-single',
            name: 'Trace íŒŒì¼ ë‹¨ì¼ì„±',
            pass: typeof data.fileName === 'string' && data.fileName.includes('_trace.json'),
            message: (typeof data.fileName === 'string' && data.fileName.includes('_trace.json'))
                ? 'ì˜¬ë°”ë¥¸ trace íŒŒì¼ í˜•ì‹'
                : 'íŒŒì¼ëª…ì´ *_trace.json í˜•ì‹ì´ ì•„ë‹˜'
        });

        // 2. <T> consistency (runId 12ìë¦¬ + rawì— ë“±ì¥)
        const tValue = data.runId;
        const okLen = /^\d{12}$/.test(tValue);
        const tMatches = okLen ? (rawText.match(new RegExp(tValue, 'g')) || []).length : 0;
        results.push({
            id: 't-consistency',
            name: '<T> ì‹œê°„ ì¼ê´€ì„±',
            pass: okLen && tMatches >= 1,
            message: okLen
                ? `Run ID ${tValue} í™•ì¸ë¨ (${tMatches}íšŒ ë“±ì¥)`
                : 'Run IDê°€ 12ìë¦¬(YYYYMMDDHHmm)ê°€ ì•„ë‹˜'
        });

        // 3. Group relation explicit
        results.push({
            id: 'group-relation',
            name: 'ê·¸ë£¹ ê°„ ê´€ê³„ ëª…ì‹œ',
            pass: !!(data.groupRelation && data.groupRelation.found),
            message: (data.groupRelation && data.groupRelation.found)
                ? data.groupRelation.text
                : 'ê·¸ë£¹ ê°„ ê´€ê³„ê°€ ëª…ì‹œë˜ì§€ ì•ŠìŒ (ì‹¤íŒ¨ ì¡°ê±´)'
        });

        // 4. Skills record (ìŠ¤í‚¬ì€ ì„ íƒ: ì—†ìœ¼ë©´ ì •ìƒ)
        results.push({
            id: 'skills-record',
            name: 'ìŠ¤í‚¬ ì‚¬ìš© ê¸°ë¡',
            pass: Array.isArray(data.skills),
            message: Array.isArray(data.skills)
                ? (data.skills.length > 0 ? `${data.skills.length}ê°œ ìŠ¤í‚¬ ê¸°ë¡ í™•ì¸` : 'ìŠ¤í‚¬ ì‚¬ìš© ì—†ìŒ (ì •ìƒ)')
                : 'skills í•„ë“œê°€ ë°°ì—´ì´ ì•„ë‹˜'
        });

        // 5. Skills have scope (ëª¨ë“  ìŠ¤í‚¬ scope í•„ìˆ˜)
        const skills = Array.isArray(data.skills) ? data.skills : [];
        const skillsWithScope = skills.filter(s => {
            const v = (s && s.scope ? String(s.scope).trim() : '');
            return v && v !== '-' && v !== 'ì•Œ ìˆ˜ ì—†ìŒ';
        }).length;

        results.push({
            id: 'skills-scope',
            name: 'ìŠ¤í‚¬ Scope ê¸°ë¡',
            pass: skillsWithScope === skills.length,
            message: skills.length === 0
                ? 'ìŠ¤í‚¬ ì—†ìŒ'
                : `${skillsWithScope}/${skills.length} ìŠ¤í‚¬ì— scope ê¸°ë¡ë¨`
        });

        // 6. Required sections (groups/artifacts; skills optional)
        const hasGroups = Array.isArray(data.groups) && data.groups.length > 0;
        const hasArtifacts = Array.isArray(data.artifacts) && data.artifacts.length > 0;
        const foundCount = [hasGroups, hasArtifacts].filter(Boolean).length;

        results.push({
            id: 'required-sections',
            name: 'í•„ìˆ˜ ì„¹ì…˜ ì™„ë¹„',
            pass: foundCount >= 2,
            message: `${foundCount}/2 í•„ìˆ˜ ì„¹ì…˜ í™•ì¸ (ê·¸ë£¹/ì‚°ì¶œë¬¼)`
        });

        return results;
    }

    // Update UI
    function updateDashboard() {
        if (!traceData) return;

        emptyState.style.display = 'none';
        dashboardGrid.classList.add('active');

        // Update header
        document.querySelector('#runIdDisplay strong').textContent = traceData.runId;

        const statusBadge = document.querySelector('#statusDisplay .status-badge');
        statusBadge.className = `status-badge ${traceData.status}`;
        statusBadge.textContent =
            traceData.status === 'success' ? 'ì™„ë£Œ' :
            traceData.status === 'failure' ? 'ì‹¤íŒ¨' : 'í™•ì¸ í•„ìš”';

        // Update run info
        document.getElementById('infoRunId').textContent = traceData.runId;
        document.getElementById('infoStartTime').textContent = formatRunId(traceData.runId);
        document.getElementById('infoGroupCount').textContent = traceData.groups.length + 'ê°œ';
        document.getElementById('infoSkillCount').textContent = traceData.skills.length + 'ê°œ';

        // Update group relation
        const relationBadge = document.getElementById('relationBadge');
        relationBadge.innerHTML = `
            <span class="relation-badge ${traceData.groupRelation.type}">
                ${escapeHtml(traceData.groupRelation.text)}
            </span>
        `;

        updateGroupFlow();
        updateSwimlane();
        updateSkillsTable();
        updateArtifacts();
        updateValidationPanel();
        updateValidationSummary();
    }

    function formatRunId(runId) {
        if (!/^\d{12}$/.test(runId)) return runId;
        const year = runId.slice(0, 4);
        const month = runId.slice(4, 6);
        const day = runId.slice(6, 8);
        const hour = runId.slice(8, 10);
        const min = runId.slice(10, 12);
        return `${year}-${month}-${day} ${hour}:${min}`;
    }

    function updateGroupFlow() {
        const groupFlow = document.getElementById('groupFlow');
        groupFlow.innerHTML = '';

        traceData.groups.forEach((group, index) => {
            // ë””í´íŠ¸ íƒ€ì… ì ˆëŒ€ ë¶€ì—¬í•˜ì§€ ì•ŠìŒ: ì—†ìœ¼ë©´ unknownìœ¼ë¡œë§Œ í‘œì‹œ
            const groupType = (group && group.type) ? String(group.type) : 'unknown';

            const groupBox = document.createElement('div');
            groupBox.className = `group-box ${groupType}`;
            groupBox.innerHTML = `
                <div class="group-title">ê·¸ë£¹ ${escapeHtml(group.number ?? (index + 1))}</div>
                <div class="group-type">${
                    groupType === 'parallel' ? 'ë³‘ë ¬ ì‹¤í–‰' :
                    groupType === 'sequential' ? 'ìˆœì°¨ ì‹¤í–‰' :
                    groupType === 'dependency' ? 'ì˜ì¡´ ì‹¤í–‰' : 'ìœ í˜• ë¯¸ìƒ'
                }</div>
                <div class="group-tasks">${
                    Array.isArray(group.tasks) && group.tasks.length
                        ? escapeHtml(group.tasks.map(t => t.name).join(', '))
                        : 'íƒœìŠ¤í¬ ì—†ìŒ'
                }</div>
            `;
            groupFlow.appendChild(groupBox);

            if (index < traceData.groups.length - 1) {
                const arrow = document.createElement('div');
                arrow.className = 'flow-arrow';
                arrow.textContent =
                    traceData.groupRelation.type === 'parallel' ? 'â‡„' :
                    traceData.groupRelation.type === 'dependency' ? 'â‡¢' : 'â†’';
                groupFlow.appendChild(arrow);
            }
        });
    }

    function updateSwimlane() {
        const swimlane = document.getElementById('swimlane');
        swimlane.innerHTML = '';

        const allTasks = [];
        traceData.groups.forEach((group, idx) => {
            const groupNo = String(group.number ?? (idx + 1));
            // ì—¬ê¸°ì„œë„ ë””í´íŠ¸ íƒ€ì…ì„ ë¶€ì—¬í•˜ì§€ ì•Šê³  unknown ìœ ì§€
            const groupType = (group && group.type) ? String(group.type) : 'unknown';
            (group.tasks || []).forEach(task => {
                allTasks.push({ ...task, group: groupNo, groupType });
            });
        });

        const agents = [...new Set(allTasks.map(t => t.agent).filter(Boolean))];
        if (agents.length === 0) agents.push('ë©”ì¸ ì—ì´ì „íŠ¸');

        agents.forEach(agent => {
            const agentTasks = allTasks.filter(t => (t.agent || 'ë©”ì¸ ì—ì´ì „íŠ¸') === agent);
            const row = document.createElement('div');
            row.className = 'swimlane-row';

            row.innerHTML = `
                <div class="swimlane-label">${escapeHtml(agent)}</div>
                <div class="swimlane-track">
                    ${agentTasks.map((task, i) => {
                        const width = 100 / Math.max(agentTasks.length, 1);
                        const left = i * width;

                        // íƒ€ì…ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜, unknownì´ë©´ class ì—†ì´ í‘œì‹œ(ìƒ‰ìƒ ê°•ì œ X)
                        const typeClass =
                            (task.groupType === 'parallel' || task.groupType === 'sequential' || task.groupType === 'dependency')
                                ? task.groupType
                                : '';

                        return `
                            <div class="swimlane-bar ${typeClass} completed"
                                 style="left: ${left}%; width: ${Math.max(width - 2, 6)}%"
                                 title="${escapeHtml(task.name)}">
                                ${escapeHtml(task.name)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            swimlane.appendChild(row);
        });
    }

    function updateSkillsTable() {
        const tbody = document.getElementById('skillsTableBody');
        const skillCount = document.getElementById('skillCount');

        skillCount.textContent = `${traceData.skills.length}ê°œ`;

        if (!traceData.skills.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        âš ï¸ ìŠ¤í‚¬ ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤ (ê·œì•½ ìœ„ë°˜)
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = traceData.skills.map(skill => `
            <tr>
                <td><span class="skill-name">${escapeHtml(skill.name ?? '-')}</span></td>
                <td><span class="skill-agent">${escapeHtml(skill.agent ?? '-')}</span></td>
                <td><span class="skill-scope" title="${escapeHtml(skill.scope ?? '-')}">${escapeHtml(skill.scope ?? '-')}</span></td>
                <td>${escapeHtml(skill.result ?? '-')}</td>
                <td>${escapeHtml(skill.output ?? '-')}</td>
            </tr>
        `).join('');
    }

    function updateArtifacts() {
        const list = document.getElementById('artifactsList');

        if (!traceData.artifacts.length) {
            list.innerHTML = `
                <div style="text-align: center; color: var(--text-muted); padding: 1rem;">
                    ì‚°ì¶œë¬¼ ì—†ìŒ
                </div>
            `;
            return;
        }

        list.innerHTML = traceData.artifacts.map(artifact => `
            <div class="artifact-item">
                <div class="artifact-icon">ğŸ“„</div>
                <div class="artifact-name">${escapeHtml(artifact.name ?? '-')}</div>
                <div class="artifact-type">${escapeHtml(artifact.type ?? '-')}</div>
            </div>
        `).join('');
    }

    function updateValidationPanel() {
        const items = validationPanel.querySelectorAll('.validation-item');
        const checks = ['trace-single', 't-consistency', 'group-relation', 'skills-record', 'required-sections'];

        items.forEach((item, index) => {
            const result = validationResults.find(r => r.id === checks[index]);
            const icon = item.querySelector('.validation-icon');
            if (!result) return;

            icon.className = `validation-icon ${result.pass ? 'pass' : 'fail'}`;
            icon.textContent = result.pass ? 'âœ“' : 'âœ—';
        });
    }

    function updateValidationSummary() {
        const passCount = validationResults.filter(r => r.pass).length;
        const failCount = validationResults.filter(r => !r.pass).length;

        document.getElementById('passCount').textContent = passCount;
        document.getElementById('failCount').textContent = failCount;
        document.getElementById('warnCount').textContent = '0';

        const details = document.getElementById('validationDetails');
        details.innerHTML = validationResults.map(result => `
            <div class="validation-detail-item">
                <div class="icon" style="color: ${result.pass ? 'var(--success)' : 'var(--error)'}">
                    ${result.pass ? 'âœ…' : 'âŒ'}
                </div>
                <div class="content">
                    <div class="title">${escapeHtml(result.name)}</div>
                    <div class="desc">${escapeHtml(result.message)}</div>
                </div>
            </div>
        `).join('');
    }

    function escapeHtml(s) {
        const str = String(s ?? '');
        return str
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    // âœ… ìƒ˜í”Œ/ë°ëª¨ ë°ì´í„° ë¡œë“œëŠ” ì œê±°ë¨ (ì˜ë„ì ìœ¼ë¡œ ë¹ˆ ìƒíƒœì—ì„œ ì‹œì‘)
</script>
</body>
</html>
